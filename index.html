<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blocks Language Playground</title>
  <link rel="stylesheet" href="/playground.css">
  <script src="https://unpkg.com/@alenaksu/json-viewer@2.1.0/dist/json-viewer.bundle.js"></script>
  <style>
    /* Additional styles for select */
    .examples-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 1rem;
      background: #f6f8fa;
      border-radius: 6px;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .examples-bar label {
      font-weight: 600;
      color: #24292f;
      font-size: 14px;
    }

    .example-select {
      padding: 0.5rem 1rem;
      border: 1px solid #d0d7de;
      border-radius: 6px;
      background: white;
      font-size: 14px;
      cursor: pointer;
      min-width: 220px;
      color: #24292f;
      transition: all 0.2s;
      flex-grow: 1;
      max-width: 300px;
    }

    .example-select:hover {
      border-color: #0969da;
      background: #f6f8fa;
    }

    .example-select:focus {
      outline: 2px solid #0969da;
      outline-offset: 2px;
      border-color: #0969da;
    }

    .example-select option {
      padding: 0.5rem;
    }

    #processBtn {
      margin-left: auto;
    }
  </style>
</head>
<body>
  <div class="playground-container">
    <!-- Header -->
    <div class="playground-header">
      <h1>üß± Blocks Language Playground</h1>
      <p>Interactive parser and AST visualizer</p>
    </div>

    <!-- Error Banner -->
    <div class="error-banner" id="errorBanner">
      <strong>‚ö†Ô∏è Parse Errors:</strong>
      <ul class="error-list" id="errorList"></ul>
    </div>

    <!-- Examples -->
    <div class="examples-bar">
      <label for="exampleSelect">Examples:</label>
      <select id="exampleSelect" class="example-select">
        <option value="">-- Choose an example --</option>
        <option value="basics">Basics</option>
        <option value="scripts">Scripts</option>
        <option value="attributes">Attributes</option>
        <option value="inlines">Inlines</option>
        <option value="nested">Nested</option>
        <option value="codeblock">Code Block</option>
        <option value="comments">Comments</option>
        <option value="metadata">Metadata</option>
        <option value="invoice">Invoice</option>
      </select>
      <button class="btn btn-primary" id="processBtn">‚ö° Process</button>
    </div>

    <!-- Layout -->
    <div class="playground-layout">
      <!-- Left: Source Input -->
      <div class="playground-left">
        <div class="panel-header">Source</div>
        <textarea 
          class="source-editor" 
          id="sourceInput" 
          placeholder="Type or paste Blocks code here..."
          spellcheck="false"
        ></textarea>
      </div>

      <!-- Middle: Variables Panel -->
      <div class="playground-middle">
        <div class="panel-header">Variables (JSON)</div>
        <textarea 
          class="variables-editor" 
          id="variablesInput" 
          placeholder='{\n  "key": "value"\n}'
          spellcheck="false"
        >{}</textarea>
      </div>

      <!-- Right: Output Tabs -->
      <div class="playground-right">
        <!-- Tabs -->
        <div class="tabs">
          <button class="tab active" data-tab="output">üìÑ Output</button>
          <button class="tab" data-tab="tokens">üî§ Tokens</button>
          <button class="tab" data-tab="astTree">üå≥ AST Tree</button>
          <button class="tab" data-tab="astJson">üìä AST JSON</button>
        </div>

        <!-- Output Tab -->
        <div class="tab-content active" id="outputTab">
          <pre class="output-display" id="outputDisplay"></pre>
        </div>

        <!-- Tokens Tab -->
        <div class="tab-content" id="tokensTab">
          <div class="tokens-list" id="tokensList"></div>
        </div>

        <!-- AST Tree Tab -->
        <div class="tab-content" id="astTreeTab">
          <div class="ast-tree" id="astTree"></div>
        </div>

        <!-- AST JSON Tab -->
        <div class="tab-content" id="astJsonTab">
          <json-viewer id="astJson"></json-viewer>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { process } from './src/index.ts';
    import { createLexer } from './src/lexer/lexer.ts';

    // Get elements
    const sourceInput = document.getElementById('sourceInput');
    const variablesInput = document.getElementById('variablesInput');
    const exampleSelect = document.getElementById('exampleSelect');
    const processBtn = document.getElementById('processBtn');
    const errorBanner = document.getElementById('errorBanner');
    const errorList = document.getElementById('errorList');
    const outputDisplay = document.getElementById('outputDisplay');
    const tokensList = document.getElementById('tokensTab');
    const astTree = document.getElementById('astTree');
    const astJson = document.getElementById('astJson');

    // Examples
    const examples = {
      basics: `/* Welcome to Blocks */

Text with expression: \${2 + 2}

// Inline comment
More text here`,

      scripts: `:::calculator
Price: \${price}
Quantity: \${quantity}
Total: \${price * quantity}
:::`,

      attributes: `:::section [#main .container data-id="123"]
Content with attributes
:::

Inline with code\`snippet\`[.highlight]`,

      inlines: `This is **bold** and *italic* text.

Use code\`inline code\` for snippets.

Links: [text](url) and images: ![alt](src)`,

      nested: `:::section [.container]

  :::article [#main]
  
    /* Main Content */
    
    :::info [.note]
    This is nested
    :::
    
  :::

:::`,

      codeblock: `\`\`\`python [#snippet1 .highlight]
def hello(name):
    print(f"Hello, {name}!")

hello("World")
\`\`\``,

      comments: `/* Block comment
   Multi-line
*/

// Inline comment

Text here

/* Another block */`,

      metadata: `---
title: "My Document"
author: "Alice"
date: "2024-01-15"
price: 100
quantity: 3
---

# \${title}

Author: \${author}
Date: \${date}

Price: \${price}
Quantity: \${quantity}
Total: \${price * quantity}`,

      invoice: `---
invoice:
  number: "INV-001"
  date: "2024-01-15"
customer:
  name: "Alice Smith"
  email: "alice@example.com"
items:
  - name: "Product A"
    price: 100
  - name: "Product B"
    price: 200
---

:::invoice
/* Invoice \${invoice.number} - \${invoice.date} */

Customer: \${customer.name}
Email: \${customer.email}

Items:
- \${items[0].name}: $\${items[0].price}
- \${items[1].name}: $\${items[1].price}

Total: $\${items[0].price + items[1].price}
:::`,
    };

    // Handle Tab key in textareas (indent with 2 spaces)
    function handleTab(textarea) {
      textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
          e.preventDefault();
          
          const start = textarea.selectionStart;
          const end = textarea.selectionEnd;
          const value = textarea.value;
          
          // Insert 2 spaces at cursor position
          textarea.value = `${value.substring(0, start)}  ${value.substring(end)}`;
          
          // Move cursor after the inserted spaces
          textarea.selectionStart = textarea.selectionEnd = start + 2;
        }
      });
    }

    // Apply Tab handling to both textareas
    handleTab(sourceInput);
    handleTab(variablesInput);

    // Handle example selection
    exampleSelect.addEventListener('change', (e) => {
      const example = e.target.value;
      if (example && examples[example]) {
        sourceInput.value = examples[example];
        processSource();
      }
    });

    // Process source
    function processSource() {
      const source = sourceInput.value;

      if (!source.trim()) {
        errorBanner.classList.remove('visible');
        outputDisplay.textContent = '';
        tokensList.innerHTML = '';
        astTree.innerHTML = '';
        astJson.data = null;
        return;
      }

      try {
        // Parse variables
        let variables = {};
        try {
          const varsText = variablesInput.value.trim();
          if (varsText) {
            variables = JSON.parse(varsText);
          }
        } catch (e) {
          errorList.innerHTML = `<li>Invalid JSON in variables: ${e.message}</li>`;
          errorBanner.classList.add('visible');
          return;
        }

        // Tokenize (for Tokens tab)
        const lexer = createLexer();
        const { tokens } = lexer.tokenize(source);

        // Process: Extract metadata + Parse + Evaluate + Render
        const result = process(source, { variables });
        
        // Display errors
        if (result.errors && result.errors.length > 0) {
          errorList.innerHTML = result.errors.map(e => `<li>${e}</li>`).join('');
          errorBanner.classList.add('visible');
        } else {
          errorBanner.classList.remove('visible');
        }

        // Display output
        outputDisplay.textContent = result.output || '';

        // Display tokens
        renderTokens(tokens);

        // Display AST Tree
        renderASTTree(result.ast);

        // Display AST JSON
        astJson.data = result.ast;

        // Log for debugging
        console.log('Metadata:', result.metadata);
        console.log('Output:', result.output);
        console.log('AST:', result.ast);

      } catch (error) {
        errorList.innerHTML = `<li>${error.message}</li>`;
        errorBanner.classList.add('visible');
        console.error(error);
      }
    }

    // Render tokens
    function renderTokens(tokens) {
      const tokensContainer = document.getElementById('tokensList');
      tokensContainer.innerHTML = '';
      
      for (const token of tokens) {
        const tokenEl = document.createElement('div');
        tokenEl.className = 'token-item';
        tokenEl.innerHTML = `
          <span class="token-type">${token.tokenType.name}</span>
          <span class="token-image">${escapeHtml(token.image)}</span>
          <span class="token-pos">L${token.startLine}:${token.startColumn}</span>
        `;
        tokensContainer.appendChild(tokenEl);
      }
    }

    // Render AST Tree
    function renderASTTree(ast) {
      const treeContainer = document.getElementById('astTree');
      treeContainer.innerHTML = '';
      
      function createNode(node, depth = 0) {
        if (!node) return;
        
        const nodeEl = document.createElement('div');
        nodeEl.className = 'ast-node';
        nodeEl.style.marginLeft = `${depth * 20}px`;
        
        let label = node.type || 'Unknown';
        if (node.name) label = `${label} "${node.name}"`;
        if (node.value !== undefined) label = `${label} = ${JSON.stringify(node.value)}`;
        
        nodeEl.textContent = label;
        treeContainer.appendChild(nodeEl);
        
        if (node.children && Array.isArray(node.children)) {
          for (const child of node.children) {
            createNode(child, depth + 1);
          }
        }
      }
      
      createNode(ast);
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Tab switching
    for (const tab of document.querySelectorAll('.tab')) {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        
        // Update tabs
        for (const t of document.querySelectorAll('.tab')) {
          t.classList.remove('active');
        }
        tab.classList.add('active');
        
        // Update content
        for (const c of document.querySelectorAll('.tab-content')) {
          c.classList.remove('active');
        }
        document.getElementById(`${tabName}Tab`).classList.add('active');
      });
    }

    // Process button
    processBtn.addEventListener('click', processSource);

    // Auto-process on input (debounced)
    let timeout;
    sourceInput.addEventListener('input', () => {
      clearTimeout(timeout);
      timeout = setTimeout(processSource, 500);
    });

    variablesInput.addEventListener('input', () => {
      clearTimeout(timeout);
      timeout = setTimeout(processSource, 500);
    });

    // Initial process
    if (sourceInput.value.trim()) {
      processSource();
    }
  </script>
</body>
</html>