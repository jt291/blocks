<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blocks Language Playground</title>
  <style>
    /* CSS pour le layout et le style */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    header {
      background: #2c3e50;
      color: white;
      padding: 1rem 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    header h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }
    
    main {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      padding: 1rem;
      overflow: hidden;
    }
    
    .panel {
      display: flex;
      flex-direction: column;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      background: white;
    }
    
    .panel-header {
      background: #f5f5f5;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #ddd;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .panel-content {
      flex: 1;
      overflow: auto;
      padding: 1rem;
    }
    
    .editor-container {
      display: flex;
      height: 100%;
      position: relative;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 14px;
      line-height: 1.5;
    }

    .line-numbers {
      background: #f5f5f5;
      border-right: 1px solid #ddd;
      color: #999;
      padding: 0 0.5rem;
      text-align: right;
      user-select: none;
      min-width: 3rem;
      overflow: hidden;
    }

    .line-number {
      height: 1.5em;
      line-height: 1.5;
      position: relative;
    }

    .line-number.error {
      background: #fee;
      color: #c00;
      font-weight: bold;
    }

    .line-number.error::before {
      content: '‚ö†Ô∏è ';
      position: absolute;
      left: -1.5rem;
    }
    
    textarea {
      flex: 1;
      border: none;
      font-family: inherit;
      font-size: inherit;
      line-height: inherit;
      resize: none;
      padding: 0 0.5rem;
      background: transparent;
    }
    
    textarea:focus { outline: none; }
    
    .errors {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 4px;
      padding: 0.75rem;
      margin-top: 0.5rem;
      color: #856404;
    }
    
    .error-item {
      margin: 0.25rem 0;
      font-size: 0.9rem;
    }
    
    .ast-controls {
      display: flex;
      gap: 0.5rem;
    }
    
    button {
      padding: 0.375rem 0.75rem;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.875rem;
    }
    
    button:hover {
      background: #0056b3;
    }
    
    /* Styles for examples select */
    #examplesSelect {
      padding: 0.375rem 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      font-size: 0.875rem;
      cursor: pointer;
      min-width: 200px;
    }
    
    #examplesSelect:focus {
      outline: 2px solid #007bff;
      outline-offset: 1px;
    }
    
    /* Styles for JSON display */
    .json-display {
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 13px;
      line-height: 1.6;
      overflow: auto;
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 4px;
      margin: 0;
    }
    
    .json-key {
      color: #0066cc;
      font-weight: bold;
    }
    
    .json-string {
      color: #22863a;
    }
    
    .json-number {
      color: #005cc5;
    }
    
    .json-boolean {
      color: #d73a49;
    }
    
    .json-null {
      color: #6f42c1;
    }

    /* AST Tree Styles */
    .ast-node {
      margin-left: 1rem;
    }

    .ast-node-header {
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 3px;
      display: inline-block;
      margin: 0.125rem 0;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 13px;
    }

    .ast-node-header:hover {
      background: #e9ecef;
    }

    .toggle-icon {
      display: inline-block;
      width: 1.5em;
      text-align: left;
      user-select: none;
    }

    .ast-node-children {
      margin-left: 0.5rem;
    }

    .ast-node-children.collapsed {
      display: none;
    }

    .node-meta {
      color: #666;
      font-style: italic;
    }

    .node-content-preview {
      color: #22863a;
    }

    .node-Document {
      font-weight: bold;
      color: #0366d6;
    }

    .node-GenericBlock, .node-CodeBlock, .node-ScriptBlock, .node-CommentBlock {
      color: #6f42c1;
    }

    .node-GenericInline, .node-CodeInline, .node-ScriptInline, .node-CommentInline {
      color: #d73a49;
    }

    .node-Text {
      color: #22863a;
    }

    /* JSON Tree Viewer Styles */
    .json-node {
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 13px;
      line-height: 1.6;
    }

    .json-line {
      white-space: pre;
    }

    .json-key {
      color: #881391;
      font-weight: 500;
    }

    .json-string {
      color: #1A1AA6;
    }

    .json-number {
      color: #1C00CF;
    }

    .json-boolean {
      color: #0000FF;
    }

    .json-null {
      color: #808080;
    }

    .json-punctuation {
      color: #000000;
    }

    .json-toggle {
      display: inline-block;
      width: 1.2em;
      font-weight: bold;
      color: #666;
      cursor: pointer;
      user-select: none;
    }

    .json-toggle:hover {
      color: #000;
    }

    .json-children {
      margin-left: 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>üß± Blocks Language Playground</h1>
  </header>
  
  <main>
    <!-- Editor Panel -->
    <div class="panel">
      <div class="panel-header">
        Editor
        <select id="examplesSelect">
          <option value="">-- Select an example --</option>
          <optgroup label="Commentaires">
            <option value="comment-block-simple">Commentaire de bloc simple</option>
            <option value="comment-block-named">Commentaire de bloc nomm√©</option>
            <option value="comment-inline-simple">Commentaire inline simple</option>
            <option value="comment-inline-named">Commentaire inline nomm√©</option>
          </optgroup>
          <optgroup label="Blocs de code">
            <option value="code-block-simple">Bloc de code simple</option>
            <option value="code-block-named">Bloc de code nomm√©</option>
            <option value="code-block-attrs">Bloc de code nomm√© avec attributs</option>
          </optgroup>
          <optgroup label="Blocs de script">
            <option value="script-block-simple">Bloc de script simple</option>
            <option value="script-block-named">Bloc de script nomm√©</option>
            <option value="script-block-attrs">Bloc de script nomm√© avec attributs</option>
          </optgroup>
          <optgroup label="Inlines">
            <option value="inline-code">Code inline simple et nomm√©</option>
            <option value="inline-script">Script inline simple et nomm√©</option>
            <option value="inline-generic">G√©n√©rique inline simple et nomm√©</option>
          </optgroup>
          <optgroup label="Blocs g√©n√©riques">
            <option value="generic-block-simple">Bloc g√©n√©rique simple</option>
            <option value="generic-block-named">Bloc g√©n√©rique nomm√©</option>
            <option value="generic-block-attrs">Bloc g√©n√©rique avec attributs</option>
            <option value="generic-block-nested-simple">Blocs g√©n√©riques imbriqu√©s simples</option>
            <option value="generic-block-nested-complex">Blocs g√©n√©riques imbriqu√©s complexes</option>
            <option value="generic-block-html">Bloc g√©n√©rique avec HTML</option>
            <option value="generic-block-mixed">Bloc g√©n√©rique avec contenu mixte</option>
          </optgroup>
          <optgroup label="Exemples complexes">
            <option value="complex-complete">Exemple complet</option>
            <option value="complex-document">Document complet</option>
            <option value="complex-multiple">Imbrications multiples</option>
          </optgroup>
          <optgroup label="Exemples avec erreurs">
            <option value="error-comment-unclosed">Commentaire bloc non ferm√©</option>
            <option value="error-comment-malformed">Commentaire bloc mal form√©</option>
            <option value="error-codeblock-unclosed">Bloc de code non ferm√©</option>
            <option value="error-codeblock-mismatch">Bloc de code longueurs diff√©rentes</option>
            <option value="error-scriptblock-unclosed">Bloc de script non ferm√©</option>
            <option value="error-scriptblock-mismatch">Bloc de script longueurs diff√©rentes</option>
            <option value="error-generic-unclosed">Bloc g√©n√©rique non ferm√©</option>
            <option value="error-generic-mismatch">Bloc g√©n√©rique longueurs diff√©rentes</option>
            <option value="error-generic-attributes">Attributs mal form√©s</option>
            <option value="error-inline-code-unclosed">Code inline non ferm√©</option>
            <option value="error-inline-generic-unclosed">Inline g√©n√©rique non ferm√©</option>
          </optgroup>
        </select>
      </div>
      <div class="panel-content">
        <div class="editor-container">
          <div class="line-numbers" id="lineNumbers"></div>
          <textarea id="editor" spellcheck="false"></textarea>
        </div>
      </div>
      <div id="errors" style="display: none;"></div>
    </div>
    
    <!-- AST Panel -->
    <div class="panel">
      <div class="panel-header">
        AST (JSON)
        <div class="ast-controls">
          <button id="expandAll">Expand All</button>
          <button id="collapseAll">Collapse All</button>
          <button id="copyJson">Copy JSON</button>
        </div>
      </div>
      <div class="panel-content">
        <pre id="astTree" class="json-display"></pre>
      </div>
    </div>
  </main>
  
  <script type="module">
    // Import the parser
    import { parse } from './dist/playground.js';
    
    const editor = document.getElementById('editor');
    const lineNumbers = document.getElementById('lineNumbers');
    const astTreeEl = document.getElementById('astTree');
    const errorsEl = document.getElementById('errors');
    const examplesSelect = document.getElementById('examplesSelect');
    const copyJsonBtn = document.getElementById('copyJson');
    const expandAllBtn = document.getElementById('expandAll');
    const collapseAllBtn = document.getElementById('collapseAll');
    
    let currentAst = null;
    let parseTimeout = null;
    
    // Examples dictionary
    const examples = {
      // Commentaires
      'comment-block-simple': `/* This is a simple block comment */`,
      
      'comment-block-named': `/*#note This is a named block comment */`,
      
      'comment-inline-simple': `Text with // inline comment`,
      
      'comment-inline-named': `//#todo Add more features
Text continues here`,
      
      // Blocs de code
      'code-block-simple': '```\nconst x = 1;\nconsole.log(x);\n```',
      
      'code-block-named': '```#javascript\nconst greeting = "Hello";\nconsole.log(greeting);\n```',
      
      'code-block-attrs': '```#python {#code1 .highlight .numbered}\ndef hello():\n    print("Hello World")\n```',
      
      // Blocs de script
      'script-block-simple': '!!!\nalert("Hello");\n!!!',
      
      'script-block-named': '!!!#javascript\nconst data = { key: "value" };\nconsole.log(data);\n!!!',
      
      'script-block-attrs': '!!!#python {#script1 .executable}\nimport sys\nprint(sys.version)\n!!!',
      
      // Inlines
      'inline-code': 'Text with `inline code` and `#javascript const x = 1` examples.',
      
      'inline-script': 'Execute !alert("Hi")! or !#javascript console.log("test")! inline.',
      
      'inline-generic': 'Use :emphasis: or :#strong Bold text: for styling.',
      
      // Blocs g√©n√©riques simples
      'generic-block-simple': `:::
This is a simple generic block
with multiple lines
:::`,
      
      'generic-block-named': `:::#container
This is a named generic block
:::`,
      
      'generic-block-attrs': `:::#section {#main .wrapper .highlighted}
Content with id and classes
:::`,
      
      'generic-block-nested-simple': `:::
Outer block
:::::
Inner block
:::::
:::`,
      
      'generic-block-nested-complex': `:::#outer {#container}
Level 1 content

::::::#inner1 {.box}
Level 2 - First inner
::::::

::::::#inner2 {.box}
Level 2 - Second inner

:::::::
Level 3 nested
:::::::
::::::
:::`,
      
      'generic-block-html': `:::#article
<h2>HTML Title</h2>
<p>Paragraph with <strong>bold</strong> text.</p>
<ul>
  <li>Item 1</li>
  <li>Item 2</li>
</ul>
:::`,
      
      'generic-block-mixed': `:::#wrapper
Regular text with :emphasis: inline.

\`\`\`#javascript
const mixed = true;
\`\`\`

More text with \`code\` and :#link clickable: {href="#"}.
:::`,
      
      // Exemples complexes
      'complex-complete': `/* #include header.html */

:::#container {#main .wrapper}
Text with \`code\` and :emphasis:

\`\`\`#javascript
const x = 1;
\`\`\`

:::::
Nested block
:::::
:::

!!!#python
print("Hello World")
!!!

// This is a comment
//#todo Add more features`,
      
      'complex-document': `/* Document metadata */
/*#title My Document */
/*#author John Doe */

:::#header {.top-bar}
Main Title

Welcome to the document.
:::

:::#content {#main}
This is the main content area.

\`\`\`#python {.code-sample}
def example():
    return "Hello"
\`\`\`

Text with :emphasis: and \`inline code\`.
:::

:::#sidebar {.info-box}
Important information
Read the documentation.
:::

:::#footer
¬© 2026 - All rights reserved
// Footer comment
:::`,
      
      'complex-multiple': `:::#level1
First level

::::::#level2a
Second level A

::::::::#level3
Third level
::::::::
::::::

::::::#level2b
Second level B

::::::::#level3a
Third level A
::::::::

::::::::#level3b
Third level B

::::::::::#level4
Fourth level with \`code\` and :inline:
::::::::::
::::::::
::::::
:::`,
      
      // Erreurs de commentaires
      'error-comment-unclosed': `/* Ce commentaire n'est pas ferm√©
Le parser attend un */`,
      
      'error-comment-malformed': `/* Commentaire avec d√©limiteur mal form√© /
Il manque l'ast√©risque */`,
      
      // Erreurs de blocs de code
      'error-codeblock-unclosed': `\`\`\`
Code sans fermeture
Le parser attend \`\`\``,
      
      'error-codeblock-mismatch': `\`\`\`
Code ici
\`\`\`\`
Le d√©limiteur de fermeture a 4 backticks au lieu de 3`,
      
      // Erreurs de blocs de script
      'error-scriptblock-unclosed': `!!!
Script sans fermeture
Le parser attend !!!`,
      
      'error-scriptblock-mismatch': `!!!
Script ici
!!!!
Le d√©limiteur de fermeture a 4 points d'exclamation au lieu de 3`,
      
      // Erreurs de blocs g√©n√©riques
      'error-generic-unclosed': `:::
Bloc g√©n√©rique sans fermeture
Le parser attend :::`,
      
      'error-generic-mismatch': `:::
Bloc externe
:::
Bloc qui devrait √™tre imbriqu√©
:::
Sans d√©limiteur plus long, le premier ::: ferme le bloc trop t√¥t`,
      
      'error-generic-attributes': `:::{#id .class
Attributs non ferm√©s - il manque }
:::`,
      
      // Erreurs d'inlines
      'error-inline-code-unclosed': `Texte avec \`code non ferm√©
Le parser attend un backtick de fermeture`,
      
      'error-inline-generic-unclosed': `Texte avec :inline non ferm√©
Le parser attend : de fermeture`
    };
    
    // Default example
    const defaultCode = examples['complex-complete'];
    
    editor.value = defaultCode;
    
    // Update line numbers
    function updateLineNumbers() {
      const lines = editor.value.split('\n');
      const lineNumbersHtml = lines.map((_, index) => 
        `<div class="line-number" data-line="${index + 1}">${index + 1}</div>`
      ).join('');
      lineNumbers.innerHTML = lineNumbersHtml;
    }

    // Highlight error lines
    function highlightErrorLines(errors) {
      // Clear previous errors
      document.querySelectorAll('.line-number.error').forEach(el => {
        el.classList.remove('error');
      });
      
      // Extract line numbers from errors
      errors.forEach(error => {
        // Try to extract line number from error message
        // Chevrotain errors might contain position info
        const lineMatch = error.match(/line (\d+)/i);
        if (lineMatch) {
          const lineNum = parseInt(lineMatch[1]);
          const lineEl = document.querySelector(`.line-number[data-line="${lineNum}"]`);
          if (lineEl) {
            lineEl.classList.add('error');
          }
        }
      });
    }

    // Sync scroll between textarea and line numbers
    editor.addEventListener('scroll', () => {
      lineNumbers.scrollTop = editor.scrollTop;
    });

    // Handle example selection
    examplesSelect.addEventListener('change', (e) => {
      const exampleKey = e.target.value;
      if (exampleKey && examples[exampleKey]) {
        editor.value = examples[exampleKey];
        updateLineNumbers();
        parseCode();
      }
    });
    
    // Debounced parse
    function handleInput() {
      updateLineNumbers();
      clearTimeout(parseTimeout);
      parseTimeout = setTimeout(() => {
        parseCode();
      }, 300);
    }
    
    editor.addEventListener('input', handleInput);
    
    // Parse and display
    function parseCode() {
      const code = editor.value;
      const result = parse(code);
      
      currentAst = result.ast;
      
      // Display errors
      if (result.errors && result.errors.length > 0) {
        errorsEl.style.display = 'block';
        errorsEl.className = 'errors';
        errorsEl.innerHTML = '<strong>‚ö†Ô∏è Parsing Errors:</strong>' +
          result.errors.map(err => 
            `<div class="error-item">${escapeHtml(err)}</div>`
          ).join('');
        highlightErrorLines(result.errors);
      } else {
        errorsEl.style.display = 'none';
        highlightErrorLines([]);
      }
      
      // Display AST as tree
      renderAst(result.ast);
    }
    
    // Render AST as interactive tree
    function renderAst(ast) {
      astTreeEl.innerHTML = '';
      renderJsonTree(ast, astTreeEl);
    }

    // Create tree node element
    function createNodeElement(node, depth, expanded = false) {
      const container = document.createElement('div');
      container.className = 'ast-node';
      
      const header = document.createElement('div');
      header.className = `ast-node-header node-${node.type}`;
      
      const hasChildren = (Array.isArray(node.content) && node.content.length > 0) ||
                          (Array.isArray(node.children) && node.children.length > 0);
      
      const toggleIcon = document.createElement('span');
      toggleIcon.className = 'toggle-icon';
      toggleIcon.textContent = hasChildren ? (expanded ? '‚ñº ' : '‚ñ∂ ') : '  ';
      header.appendChild(toggleIcon);
      
      const typeSpan = document.createElement('span');
      typeSpan.textContent = node.type;
      header.appendChild(typeSpan);
      
      // Add metadata
      const meta = [];
      if (node.name) meta.push(`name="${node.name}"`);
      if (node.attributes?.id) meta.push(`id="${node.attributes.id}"`);
      if (node.attributes?.classes?.length) {
        meta.push(`classes=[${node.attributes.classes.map(c => `"${c}"`).join(', ')}]`);
      }
      if (node.attributes?.options?.length) {
        meta.push(`options=[${node.attributes.options.map(o => `"${o}"`).join(', ')}]`);
      }
      
      if (meta.length > 0) {
        const metaSpan = document.createElement('span');
        metaSpan.className = 'node-meta';
        metaSpan.textContent = ' { ' + meta.join(', ') + ' }';
        header.appendChild(metaSpan);
      }
      
      // Add FULL content (no truncation)
      if (typeof node.content === 'string') {
        const contentSpan = document.createElement('span');
        contentSpan.className = 'node-content-preview';
        contentSpan.textContent = ` content="${escapeHtml(node.content)}"`;
        header.appendChild(contentSpan);
      } else if (typeof node.value === 'string') {
        const valueSpan = document.createElement('span');
        valueSpan.className = 'node-content-preview';
        valueSpan.textContent = ` value="${escapeHtml(node.value)}"`;
        header.appendChild(valueSpan);
      } else if (Array.isArray(node.content) || Array.isArray(node.children)) {
        const countSpan = document.createElement('span');
        countSpan.className = 'node-meta';
        const count = (node.content || node.children).length;
        countSpan.textContent = ` [${count} child${count !== 1 ? 'ren' : ''}]`;
        header.appendChild(countSpan);
      }
      
      container.appendChild(header);
      
      // Add children
      if (hasChildren) {
        const childrenContainer = document.createElement('div');
        childrenContainer.className = 'ast-node-children';
        if (!expanded) childrenContainer.classList.add('collapsed');
        
        const children = node.content || node.children || [];
        children.forEach(child => {
          if (child && typeof child === 'object') {
            childrenContainer.appendChild(createNodeElement(child, depth + 1, false));
          }
        });
        
        container.appendChild(childrenContainer);
        
        // Toggle functionality
        header.addEventListener('click', () => {
          childrenContainer.classList.toggle('collapsed');
          toggleIcon.textContent = childrenContainer.classList.contains('collapsed') 
            ? '‚ñ∂ ' 
            : '‚ñº ';
        });
      }
      
      return container;
    }

    // Expand all nodes
    expandAllBtn.addEventListener('click', expandAllJson);

    // Collapse all nodes
    collapseAllBtn.addEventListener('click', collapseAllJson);
    
    // Render AST as formatted JSON with syntax highlighting (kept for reference)
    function renderJsonAst(ast) {
      const json = JSON.stringify(ast, null, 2);
      const highlighted = syntaxHighlightJson(json);
      astTreeEl.innerHTML = highlighted;
    }
    
    // Syntax highlight JSON
    function syntaxHighlightJson(json) {
      // Escape HTML entities first
      json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      
      return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        let cls = 'json-number';
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = 'json-key';
          } else {
            cls = 'json-string';
          }
        } else if (/true|false/.test(match)) {
          cls = 'json-boolean';
        } else if (/null/.test(match)) {
          cls = 'json-null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
      });
    }
    
    // Copy JSON
    copyJsonBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(JSON.stringify(currentAst, null, 2));
        copyJsonBtn.textContent = '‚úì Copied!';
        setTimeout(() => {
          copyJsonBtn.textContent = 'Copy JSON';
        }, 2000);
      } catch (err) {
        alert('Failed to copy to clipboard');
      }
    });
    
    // Utility functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /**
     * Render interactive JSON tree
     */
    function renderJsonTree(data, container, key = null, depth = 0) {
      const wrapper = document.createElement('div');
      wrapper.className = 'json-node';
      wrapper.style.marginLeft = `${depth * 1.5}rem`;
      
      const type = Array.isArray(data) ? 'array' : typeof data;
      
      if (type === 'object' && data !== null) {
        renderObject(data, wrapper, key, depth);
      } else if (type === 'array') {
        renderArray(data, wrapper, key, depth);
      } else {
        renderPrimitive(data, wrapper, key, type);
      }
      
      container.appendChild(wrapper);
    }

    /**
     * Render an object
     */
    function renderObject(obj, container, key, depth) {
      const keys = Object.keys(obj);
      const isEmpty = keys.length === 0;
      
      const header = document.createElement('div');
      header.className = 'json-line';
      
      if (key !== null) {
        const keySpan = document.createElement('span');
        keySpan.className = 'json-key';
        keySpan.textContent = `"${key}"`;
        header.appendChild(keySpan);
        
        const colon = document.createElement('span');
        colon.className = 'json-punctuation';
        colon.textContent = ': ';
        header.appendChild(colon);
      }
      
      let toggle = null;
      if (!isEmpty) {
        toggle = document.createElement('span');
        toggle.className = 'json-toggle';
        toggle.textContent = '‚ñº ';
        toggle.style.cursor = 'pointer';
        toggle.style.userSelect = 'none';
        toggle.style.color = '#666';
        header.insertBefore(toggle, header.firstChild);
      }
      
      const openBrace = document.createElement('span');
      openBrace.className = 'json-punctuation';
      openBrace.textContent = isEmpty ? '{}' : '{';
      header.appendChild(openBrace);
      
      container.appendChild(header);
      
      if (!isEmpty) {
        const childrenContainer = document.createElement('div');
        childrenContainer.className = 'json-children';
        
        keys.forEach((k, index) => {
          const childWrapper = document.createElement('div');
          childWrapper.style.marginLeft = '1.5rem';
          
          renderJsonTree(obj[k], childWrapper, k, 0);
          
          // Add comma if not last
          if (index < keys.length - 1) {
            const comma = document.createElement('span');
            comma.className = 'json-punctuation';
            comma.textContent = ',';
            childWrapper.querySelector('.json-line').appendChild(comma);
          }
          
          childrenContainer.appendChild(childWrapper);
        });
        
        const closeBrace = document.createElement('div');
        closeBrace.className = 'json-line';
        closeBrace.style.marginLeft = '0';
        closeBrace.innerHTML = '<span class="json-punctuation">}</span>';
        childrenContainer.appendChild(closeBrace);
        
        container.appendChild(childrenContainer);
        
        // Toggle functionality
        if (toggle) {
          toggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const isCollapsed = childrenContainer.style.display === 'none';
            childrenContainer.style.display = isCollapsed ? 'block' : 'none';
            toggle.textContent = isCollapsed ? '‚ñº ' : '‚ñ∂ ';
            
            // Update opening brace
            if (isCollapsed) {
              openBrace.textContent = '{';
              closeBrace.style.display = 'block';
            } else {
              openBrace.textContent = `{ ... } (${keys.length} ${keys.length === 1 ? 'property' : 'properties'})`;
              closeBrace.style.display = 'none';
            }
          });
        }
      }
    }

    /**
     * Render an array
     */
    function renderArray(arr, container, key, depth) {
      const isEmpty = arr.length === 0;
      
      const header = document.createElement('div');
      header.className = 'json-line';
      
      if (key !== null) {
        const keySpan = document.createElement('span');
        keySpan.className = 'json-key';
        keySpan.textContent = `"${key}"`;
        header.appendChild(keySpan);
        
        const colon = document.createElement('span');
        colon.className = 'json-punctuation';
        colon.textContent = ': ';
        header.appendChild(colon);
      }
      
      let toggle = null;
      if (!isEmpty) {
        toggle = document.createElement('span');
        toggle.className = 'json-toggle';
        toggle.textContent = '‚ñº ';
        toggle.style.cursor = 'pointer';
        toggle.style.userSelect = 'none';
        toggle.style.color = '#666';
        header.insertBefore(toggle, header.firstChild);
      }
      
      const openBracket = document.createElement('span');
      openBracket.className = 'json-punctuation';
      openBracket.textContent = isEmpty ? '[]' : '[';
      header.appendChild(openBracket);
      
      container.appendChild(header);
      
      if (!isEmpty) {
        const childrenContainer = document.createElement('div');
        childrenContainer.className = 'json-children';
        
        arr.forEach((item, index) => {
          const childWrapper = document.createElement('div');
          childWrapper.style.marginLeft = '1.5rem';
          
          renderJsonTree(item, childWrapper, null, 0);
          
          // Add comma if not last
          if (index < arr.length - 1) {
            const comma = document.createElement('span');
            comma.className = 'json-punctuation';
            comma.textContent = ',';
            childWrapper.querySelector('.json-line').appendChild(comma);
          }
          
          childrenContainer.appendChild(childWrapper);
        });
        
        const closeBracket = document.createElement('div');
        closeBracket.className = 'json-line';
        closeBracket.style.marginLeft = '0';
        closeBracket.innerHTML = '<span class="json-punctuation">]</span>';
        childrenContainer.appendChild(closeBracket);
        
        container.appendChild(childrenContainer);
        
        // Toggle functionality
        if (toggle) {
          toggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const isCollapsed = childrenContainer.style.display === 'none';
            childrenContainer.style.display = isCollapsed ? 'block' : 'none';
            toggle.textContent = isCollapsed ? '‚ñº ' : '‚ñ∂ ';
            
            // Update opening bracket
            if (isCollapsed) {
              openBracket.textContent = '[';
              closeBracket.style.display = 'block';
            } else {
              openBracket.textContent = `[ ... ] (${arr.length} ${arr.length === 1 ? 'item' : 'items'})`;
              closeBracket.style.display = 'none';
            }
          });
        }
      }
    }

    /**
     * Render a primitive value
     */
    function renderPrimitive(value, container, key, type) {
      const line = document.createElement('div');
      line.className = 'json-line';
      
      if (key !== null) {
        const keySpan = document.createElement('span');
        keySpan.className = 'json-key';
        keySpan.textContent = `"${key}"`;
        line.appendChild(keySpan);
        
        const colon = document.createElement('span');
        colon.className = 'json-punctuation';
        colon.textContent = ': ';
        line.appendChild(colon);
      }
      
      const valueSpan = document.createElement('span');
      
      if (type === 'string') {
        valueSpan.className = 'json-string';
        valueSpan.textContent = `"${escapeJsonString(value)}"`;
      } else if (type === 'number') {
        valueSpan.className = 'json-number';
        valueSpan.textContent = value;
      } else if (type === 'boolean') {
        valueSpan.className = 'json-boolean';
        valueSpan.textContent = value;
      } else if (value === null) {
        valueSpan.className = 'json-null';
        valueSpan.textContent = 'null';
      } else {
        valueSpan.textContent = String(value);
      }
      
      line.appendChild(valueSpan);
      container.appendChild(line);
    }

    /**
     * Escape JSON string
     */
    function escapeJsonString(str) {
      return str
        .replace(/\\/g, '\\\\')
        .replace(/"/g, '\\"')
        .replace(/\n/g, '\\n')
        .replace(/\r/g, '\\r')
        .replace(/\t/g, '\\t');
    }

    /**
     * Expand all JSON nodes
     */
    function expandAllJson() {
      document.querySelectorAll('.json-children').forEach(el => {
        el.style.display = 'block';
      });
      document.querySelectorAll('.json-toggle').forEach(el => {
        el.textContent = '‚ñº ';
      });
      // Reset braces/brackets text
      document.querySelectorAll('.json-punctuation').forEach(el => {
        if (el.textContent.includes('...')) {
          if (el.textContent.startsWith('{')) {
            el.textContent = '{';
          } else if (el.textContent.startsWith('[')) {
            el.textContent = '[';
          }
        }
      });
      // Show closing braces/brackets
      document.querySelectorAll('.json-children').forEach(childrenContainer => {
        const closeBrace = childrenContainer.querySelector('.json-line:last-child');
        if (closeBrace) {
          closeBrace.style.display = 'block';
        }
      });
    }

    /**
     * Collapse all JSON nodes
     */
    function collapseAllJson() {
      document.querySelectorAll('.json-children').forEach(el => {
        el.style.display = 'none';
      });
      document.querySelectorAll('.json-toggle').forEach(el => {
        el.textContent = '‚ñ∂ ';
      });
    }
    
    // Initial setup
    updateLineNumbers();
    parseCode();
  </script>
</body>
</html>
